<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance - Lecture System</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .attendance-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .teacher-info {
            background: #f0f8ff;
            border-left: 4px solid #007bff;
        }
        
        .already-marked {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
        }
        
        .verification-area {
            text-align: center;
        }
        
        #video-feed {
            width: 100%;
            max-width: 640px;
            height: 480px;
            border: 3px solid #ddd;
            border-radius: 8px;
            background: #000;
            margin: 20px auto;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #545b62; }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status-info {
            background-color: #e7f3ff;
            border-left: 4px solid #2196F3;
        }
        
        .status-success {
            background-color: #e8f5e8;
            border-left: 4px solid #4CAF50;
        }
        
        .status-error {
            background-color: #ffe7e7;
            border-left: 4px solid #f44336;
        }
        
        .status-warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        
        .location-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .result-card {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <%- include('../partials/header') %>
    
    <div class="container">
        <div class="attendance-container">
            <h1>Mark Your Attendance</h1>
            
            <!-- Teacher Information -->
            <div class="card teacher-info">
                <h3>Teacher Information</h3>
                <p><strong>Name:</strong> <%= teacher.name %></p>
                <p><strong>Email:</strong> <%= teacher.email %></p>
                <p><strong>Subjects:</strong> <%= teacher.subjects.join(', ') %></p>
                <p><strong>Today's Date:</strong> <span id="currentDate"></span></p>
                <% if (teacher.imageUrl) { %>
                    <p><strong>Face Image:</strong> ‚úÖ Registered</p>
                <% } else { %>
                    <p><strong>Face Image:</strong> ‚ùå Not registered</p>
                <% } %>
            </div>

            <!-- Check Today's Attendance Status -->
            <div id="attendanceStatusCard" class="card">
                <h3>Today's Attendance Status</h3>
                <div id="attendanceStatusContent">
                    Loading attendance status...
                </div>
            </div>

            <!-- Attendance Verification -->
            <div class="card verification-area">
                <h3>Face & Location Verification</h3>
                <p>Please allow camera and location access to mark your attendance.</p>
                
                <div class="button-group">
                    <button id="startBtn" class="btn btn-success">Start Verification</button>
                    <button id="stopBtn" class="btn btn-danger" disabled>Stop Verification</button>
                    <button id="checkStatusBtn" class="btn btn-secondary">Refresh Status</button>
                </div>

                <div id="status" class="status status-info">
                    Ready to start verification...
                </div>

                <div id="locationInfo" class="location-info hidden">
                    <strong>üìç Location Status:</strong> <span id="locationStatus">Waiting for location...</span>
                </div>

                <img id="video-feed" src="" alt="Webcam Feed" class="hidden">

                <div id="attendanceResult" class="card result-card hidden">
                    <h3>‚úÖ Attendance Recorded Successfully!</h3>
                    <div id="resultDetails"></div>
                    <a href="/teacher/dashboard" class="btn">Back to Dashboard</a>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card">
                <h3>Instructions & Rules</h3>
                <ol style="text-align: left;">
                    <li>You can mark attendance only <strong>ONCE per day</strong></li>
                    <li>Click "Start Verification" button</li>
                    <li>Allow camera access when prompted</li>
                    <li>Allow location access when prompted</li>
                    <li>Look directly at the camera</li>
                    <li>Wait for face verification and location check</li>
                    <li>Attendance will be automatically recorded</li>
                </ol>
                <p><strong>Requirements:</strong></p>
                <ul style="text-align: left;">
                    <li>‚úÖ Must be within <strong>500 meters</strong> of the school</li>
                    <li>‚úÖ Face must match registered image</li>
                    <li>‚úÖ One attendance record per day only</li>
                </ul>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>
    
   <script>
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const checkStatusBtn = document.getElementById('checkStatusBtn');
const videoFeed = document.getElementById('video-feed');
const statusDiv = document.getElementById('status');
const locationInfo = document.getElementById('locationInfo');
const locationStatus = document.getElementById('locationStatus');
const attendanceResult = document.getElementById('attendanceResult');
const resultDetails = document.getElementById('resultDetails');
const attendanceStatusContent = document.getElementById('attendanceStatusContent');
const currentDateSpan = document.getElementById('currentDate');

let verificationActive = false;
let statusCheckInterval = null;

currentDateSpan.textContent = new Date().toLocaleDateString();

function updateStatus(message, type = 'info') {
    statusDiv.textContent = message;
    statusDiv.className = `status status-${type}`;
    statusDiv.style.display = 'block';
}

/* ===============================
   CHECK TODAY'S ATTENDANCE
================================ */
async function checkTodaysAttendance() {
    try {
        const res = await fetch(`/teacher/attendance-status?email=<%= teacher.email %>&t=${Date.now()}`);
        const data = await res.json();

        if (data.success && data.data.attendanceMarked) {
            attendanceStatusContent.innerHTML = `
                <div class="status status-success">
                    ‚úÖ Attendance already marked at ${data.data.attendance.time}
                </div>`;
            startBtn.disabled = true;
            showAttendanceResult(true);
        } else {
            attendanceStatusContent.innerHTML = `
                <div class="status status-info">
                    ‚è≥ Attendance not marked yet
                </div>`;
        }
    } catch (err) {
        attendanceStatusContent.innerHTML = `<div class="status status-error">Failed to load status</div>`;
    }
}
checkTodaysAttendance();

/* ===============================
   GET LOCATION (BROWSER)
================================ */
function getLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            reject("Geolocation not supported");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            pos => resolve(pos),
            () => reject("Location permission denied"),
            { enableHighAccuracy: true, timeout: 15000 }
        );
    });
}

/* ===============================
   SEND LOCATION ‚Üí NODE ‚Üí PYTHON
================================ */
async function sendLocation(latitude, longitude) {
    const res = await fetch("/teacher/set-location", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ latitude, longitude })
    });

    const data = await res.json();

    if (!data.status) throw new Error("Location rejected");

    locationStatus.textContent =
        `Distance from school: ${data.distance_from_school.toFixed(1)}m`;
    locationInfo.style.display = "block";

    return data.within_range;
}

/* ===============================
   CHECK VERIFICATION STATUS
================================ */
async function checkVerificationStatus() {
    if (!verificationActive) return;

    try {
        const res = await fetch("/teacher/verification-status");
        const status = await res.json();

        if (status.attendance_done) {
            updateStatus("‚úÖ Attendance marked successfully!", "success");
            showAttendanceResult(true);
            stopVerification();
        } else {
            updateStatus("Face verification in progress...", "info");
        }
    } catch (err) {
        console.error(err);
    }
}

/* ===============================
   SHOW RESULT
================================ */
function showAttendanceResult() {
    resultDetails.innerHTML = `
        <p><strong>Teacher:</strong> <%= teacher.name %></p>
        <p><strong>Email:</strong> <%= teacher.email %></p>
        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
        <p><strong>Time:</strong> ${new Date().toLocaleTimeString()}</p>
        <p><strong>Status:</strong> ‚úÖ Verified</p>
    `;
    attendanceResult.style.display = "block";
}

/* ===============================
   STOP VERIFICATION
================================ */
function stopVerification() {
    verificationActive = false;
    clearInterval(statusCheckInterval);
    videoFeed.style.display = "none";
    videoFeed.src = "";
    startBtn.disabled = false;
    stopBtn.disabled = true;
}

/* ===============================
   START VERIFICATION
================================ */
startBtn.addEventListener("click", async () => {
    try {
        verificationActive = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;

        updateStatus("Initializing verification...");

        /* 1Ô∏è‚É£ Start verification */
        const res = await fetch("/teacher/start-verification", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                email: "<%= teacher.email %>",
                imageUrl: "<%= teacher.imageUrl %>"
            })
        });

        const data = await res.json();
        if (!data.success) throw new Error("Verification init failed");

        /* 2Ô∏è‚É£ Location */
        updateStatus("Getting location...");
        const pos = await getLocation();
        const ok = await sendLocation(pos.coords.latitude, pos.coords.longitude);
        if (!ok) throw new Error("Too far from school");

        /* 3Ô∏è‚É£ Video feed */
        updateStatus("Location verified. Starting camera...", "success");
        videoFeed.src = "/teacher/video-feed";
        videoFeed.style.display = "block";

        /* 4Ô∏è‚É£ Poll status */
        statusCheckInterval = setInterval(checkVerificationStatus, 2000);

    } catch (err) {
        updateStatus("‚ùå " + err.message, "error");
        stopVerification();
    }
});

/* ===============================
   STOP BUTTON
================================ */
stopBtn.addEventListener("click", async () => {
    await fetch("/teacher/stop-verification", { method: "POST" });
    stopVerification();
});
</script>

</body>
</html>